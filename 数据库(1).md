# iCalligraphy 数据库设计文档

**版本**: v1.0  
**更新日期**: 2025-12-03  
**数据库类型**: SQLite 

---

## 📋 目录

1. [数据库概览](#数据库概览)
2. [用户相关表](#用户相关表)
3. [作品相关表](#作品相关表)
4. [社区相关表](#社区相关表)
5. [关系表](#关系表)
6. [系统表](#系统表)
7. [数据库关系图](#数据库关系图)
8. [索引设计](#索引设计)
9. [数据迁移脚本](#数据迁移脚本)

---

## 数据库概览

### 表清单

| 序号  | 表名            | 中文名   | 说明          |
| --- | ------------- | ----- | ----------- |
| 1   | users         | 用户表   | 存储用户基本信息    |
| 2   | follows       | 关注关系表 | 存储用户之间的关注关系 |
| 3   | works         | 作品表   | 存储书法作品信息    |
| 4   | characters    | 单字表   | 存储作品中的单个汉字  |
| 5   | annotations   | 读帖注释表 | 存储用户的读帖分析   |
| 6   | comments      | 评论表   | 存储作品评论      |
| 7   | collections   | 收藏表   | 存储作品收藏记录    |
| 8   | likes         | 点赞表   | 存储作品点赞记录    |
| 9   | posts         | 帖子表   | 存储社区帖子      |
| 10  | post_likes    | 帖子点赞表 | 存储帖子点赞记录    |
| 11  | post_comments | 帖子评论表 | 存储帖子评论      |
| 12  | notifications | 通知表   | 存储用户通知      |
| 13  | checkins      | 打卡表   | 存储每日打卡记录    |

---

## 用户相关表

### 1. users（用户表）

**表名**: `users`  
**说明**: 存储用户的基本信息和账号数据

| 字段名           | 类型           | 约束                                  | 说明                             |
| ------------- | ------------ | ----------------------------------- | ------------------------------ |
| id            | INTEGER      | PRIMARY KEY                         | 用户ID，主键，自增                     |
| username      | VARCHAR(80)  | NOT NULL, UNIQUE, INDEX             | 用户名，唯一，用于登录                    |
| email         | VARCHAR(120) | NOT NULL, UNIQUE, INDEX             | 邮箱地址，唯一，用于登录和找回密码              |
| password_hash | VARCHAR(255) | NOT NULL                            | 密码哈希值，使用werkzeug加密             |
| phone         | VARCHAR(20)  | UNIQUE                              | 手机号码，唯一，用于绑定和找回密码              |
| avatar        | VARCHAR(255) | DEFAULT 'default_avatar.png'        | 头像文件路径，默认为默认头像                 |
| bio           | TEXT         | NULL                                | 个人简介，最多200字                    |
| gender        | VARCHAR(10)  | NULL                                | 性别：male（男）/female（女）/other（其他） |
| birthdate     | DATE         | NULL                                | 出生日期，格式：YYYY-MM-DD             |
| is_active     | BOOLEAN      | DEFAULT TRUE                        | 账号是否激活，用于封禁管理                  |
| is_admin      | BOOLEAN      | DEFAULT FALSE                       | 是否为管理员，管理员拥有审核权限               |
| created_at    | DATETIME     | DEFAULT CURRENT_TIMESTAMP           | 账号创建时间                         |
| updated_at    | DATETIME     | DEFAULT CURRENT_TIMESTAMP ON UPDATE | 最后更新时间                         |

**索引**:

- PRIMARY KEY: `id`
- UNIQUE INDEX: `username`, `email`, `phone`
- INDEX: `created_at`

**关系**:

- 一对多：`works`（作品）
- 一对多：`comments`（评论）
- 一对多：`collections`（收藏）
- 一对多：`likes`（点赞）
- 一对多：`posts`（帖子）
- 一对多：`annotations`（读帖）
- 一对多：`checkins`（打卡）
- 一对多：`notifications`（通知）
- 多对多：通过`follows`表与自身建立关注关系

**业务规则**:

- `username`：3-20个字符，只能包含字母、数字、下划线
- `email`：必须是有效的邮箱格式
- `phone`：11位数字（中国大陆手机号）
- `password_hash`：使用`werkzeug. security. generate_password_hash`加密
- `is_active=false`时，用户无法登录

**示例数据**:

```sql
INSERT INTO users (username, email, password_hash, phone, gender, birthdate, bio, is_admin)
VALUES ('admin', 'admin@example.com', 'pbkdf2:sha256:... ', '13800138000', 'male', '1990-01-01', '书法爱好者', TRUE);
```

---

### 2. follows（关注关系表）

**表名**: `follows`  
**说明**: 存储用户之间的关注关系

| 字段名          | 类型       | 约束                        | 说明                     |
| ------------ | -------- | ------------------------- | ---------------------- |
| id           | INTEGER  | PRIMARY KEY               | 关注关系ID，主键，自增           |
| follower_id  | INTEGER  | NOT NULL, FOREIGN KEY     | 关注者的用户ID，外键关联users. id |
| following_id | INTEGER  | NOT NULL, FOREIGN KEY     | 被关注者的用户ID，外键关联users.id |
| created_at   | DATETIME | DEFAULT CURRENT_TIMESTAMP | 关注时间                   |

**索引**:

- PRIMARY KEY: `id`
- UNIQUE INDEX: `(follower_id, following_id)` - 防止重复关注
- INDEX: `follower_id` - 查询某人关注了谁
- INDEX: `following_id` - 查询某人的粉丝

**约束**:

- UNIQUE: `(follower_id, following_id)` - 一个用户不能重复关注同一个人
- CHECK: `follower_id != following_id` - 不能关注自己

**外键关系**:

- `follower_id` → `users.id` (CASCADE DELETE)
- `following_id` → `users.id` (CASCADE DELETE)

**业务规则**:

- 用户不能关注自己
- 同一对关注关系只能存在一次
- 删除用户时，相关的关注关系自动删除

**查询示例**:

```sql
-- 查询用户1的关注列表
SELECT u.* FROM users u
INNER JOIN follows f ON u.id = f.following_id
WHERE f.follower_id = 1;

-- 查询用户1的粉丝列表
SELECT u.* FROM users u
INNER JOIN follows f ON u.id = f.follower_id
WHERE f.following_id = 1;

-- 查询用户1的粉丝数
SELECT COUNT(*) FROM follows WHERE following_id = 1;

-- 查询用户1的关注数
SELECT COUNT(*) FROM follows WHERE follower_id = 1;
```

---

## 作品相关表

### 3. works（作品表）

**表名**: `works`  
**说明**: 存储书法作品的基本信息

| 字段名             | 类型           | 约束                                  | 说明                                            |
| --------------- | ------------ | ----------------------------------- | --------------------------------------------- |
| id              | INTEGER      | PRIMARY KEY                         | 作品ID，主键，自增                                    |
| title           | VARCHAR(200) | NOT NULL                            | 作品名称，必填                                       |
| description     | TEXT         | NULL                                | 作品描述/介绍，可选                                    |
| image_url       | VARCHAR(255) | NOT NULL                            | 作品图片路径，必填                                     |
| style           | VARCHAR(50)  | NULL                                | 书法风格：楷书/行书/草书/隶书/篆书等                          |
| dynasty         | VARCHAR(50)  | NULL                                | 所属朝代：唐/宋/元/明/清等                               |
| author_name     | VARCHAR(100) | NULL                                | 书法作品的原作者（历史人物，如王羲之）                           |
| author_id       | INTEGER      | NOT NULL, FOREIGN KEY               | 上传者ID，外键关联users. id                           |
| character_count | INTEGER      | DEFAULT 0                           | 识别出的单字数量                                      |
| views           | INTEGER      | DEFAULT 0                           | 浏览次数，每次查看详情+1                                 |
| status          | VARCHAR(20)  | DEFAULT 'pending'                   | 审核状态：pending（待审核）/approved（已通过）/rejected（已拒绝） |
| reject_reason   | TEXT         | NULL                                | 拒绝原因，仅当status=rejected时有值                     |
| created_at      | DATETIME     | DEFAULT CURRENT_TIMESTAMP           | 上传时间                                          |
| updated_at      | DATETIME     | DEFAULT CURRENT_TIMESTAMP ON UPDATE | 最后更新时间                                        |

**索引**:

- PRIMARY KEY: `id`
- INDEX: `author_id` - 查询某用户的作品
- INDEX: `status` - 筛选审核状态
- INDEX: `style` - 按风格筛选
- INDEX: `dynasty` - 按朝代筛选
- INDEX: `views` - 按浏览量排序
- INDEX: `created_at` - 按时间排序

**外键关系**:

- `author_id` → `users. id` (CASCADE DELETE)

**业务规则**:

- `status`只能是`pending`、`approved`、`rejected`之一
- 新上传的作品默认`status='pending'`，需要管理员审核
- 普通用户只能查看`status='approved'`的作品
- `character_count`根据关联的`characters`表记录自动计算
- `views`字段在每次访问作品详情时自动+1

**示例数据**:

```sql
INSERT INTO works (title, description, image_url, style, dynasty, author_name, author_id, character_count, status)
VALUES ('兰亭序', '天下第一行书', '/uploads/works/lantingxu.jpg', '行书', '东晋', '王羲之', 1, 324, 'approved');
```

---

### 4. characters（单字表）

**表名**: `characters`  
**说明**: 存储作品中的单个汉字及其位置信息

| 字段名            | 类型           | 约束                                  | 说明                            |
| -------------- | ------------ | ----------------------------------- | ----------------------------- |
| id             | INTEGER      | PRIMARY KEY                         | 单字ID，主键，自增                    |
| text           | VARCHAR(10)  | NOT NULL, INDEX                     | 单字内容，如"永"                     |
| work_id        | INTEGER      | NOT NULL, FOREIGN KEY               | 所属作品ID，外键关联works.id           |
| position       | JSON         | NULL                                | 在作品图片中的位置坐标[x1,y1,x2,y2]，单位像素 |
| stroke_count   | INTEGER      | NULL                                | 笔画数                           |
| stroke_order   | TEXT         | NULL                                | 笔顺描述，如"点、横、竖、撇、捺"             |
| image_url      | VARCHAR(255) | NULL                                | 单字截图路径，从原图裁剪得到                |
| ocr_confidence | FLOAT        | NULL                                | OCR识别置信度，0-1之间                |
| created_at     | DATETIME     | DEFAULT CURRENT_TIMESTAMP           | 创建时间                          |
| updated_at     | DATETIME     | DEFAULT CURRENT_TIMESTAMP ON UPDATE | 更新时间                          |

**索引**:

- PRIMARY KEY: `id`
- INDEX: `text` - 按字名搜索
- INDEX: `work_id` - 查询某作品的所有单字
- INDEX: `(work_id, text)` - 联合索引

**外键关系**:

- `work_id` → `works.id` (CASCADE DELETE)

**业务规则**:

- `position`格式：`[x1, y1, x2, y2]`，表示左上角坐标(x1,y1)和右下角坐标(x2,y2)
- `text`应该是单个汉字，但也可以是词组（如"兰亭"）
- `ocr_confidence`来自OCR识别结果，值越高表示识别越准确
- 删除作品时，相关的单字记录自动删除

**JSON字段示例**:

```json
{
  "position": [100, 200, 150, 250]
}
```

**示例数据**:

```sql
INSERT INTO characters (text, work_id, position, stroke_count, stroke_order, ocr_confidence)
VALUES ('永', 1, '[100,200,150,250]', 5, '点、横、竖、撇、捺', 0.98);
```

---

### 5. annotations（读帖注释表）

**表名**: `annotations`  
**说明**: 存储用户对单字的读帖分析和临摹要点

| 字段名          | 类型          | 约束                                  | 说明                       |
| ------------ | ----------- | ----------------------------------- | ------------------------ |
| id           | INTEGER     | PRIMARY KEY                         | 读帖ID，主键，自增               |
| character_id | INTEGER     | NOT NULL, FOREIGN KEY               | 单字ID，外键关联characters.id   |
| user_id      | INTEGER     | NOT NULL, FOREIGN KEY               | 用户ID，外键关联users.id        |
| source       | VARCHAR(20) | DEFAULT 'manual'                    | 来源：manual（手动添加）/ai（AI生成） |
| keypoints    | JSON        | NULL                                | 关键点数组，包含位置和临摹要点          |
| overall_tips | TEXT        | NULL                                | 整体临摹建议                   |
| is_public    | BOOLEAN     | DEFAULT TRUE                        | 是否公开，false表示仅自己可见        |
| created_at   | DATETIME    | DEFAULT CURRENT_TIMESTAMP           | 创建时间                     |
| updated_at   | DATETIME    | DEFAULT CURRENT_TIMESTAMP ON UPDATE | 更新时间                     |

**索引**:

- PRIMARY KEY: `id`
- INDEX: `character_id` - 查询某单字的所有读帖
- INDEX: `user_id` - 查询某用户的所有读帖
- INDEX: `(character_id, user_id)` - 联合索引
- INDEX: `source` - 按来源筛选

**外键关系**:

- `character_id` → `characters.id` (CASCADE DELETE)
- `user_id` → `users.id` (CASCADE DELETE)

**业务规则**:

- `source`只能是`manual`或`ai`
- `keypoints`是JSON数组，每个元素包含`x`、`y`、`description`、`tips`
- `is_public=true`时，其他用户可以查看这个读帖
- 一个用户可以对同一个单字创建多个读帖注释

**JSON字段示例**:

```json
{
  "keypoints": [
    {
      "id": 1,
      "x": 0.5,
      "y": 0.3,
      "description": "横画起笔处",
      "tips": "注意藏锋起笔，笔尖轻触纸面后向右缓缓推进"
    },
    {
      "id": 2,
      "x": 0.45,
      "y": 0.6,
      "description": "竖画与横画交叉点",
      "tips": "笔画交叉要自然"
    }
  ]
}
```

**示例数据**:

```sql
INSERT INTO annotations (character_id, user_id, source, keypoints, overall_tips, is_public)
VALUES (1, 1, 'ai', '[{"x":0.5,"y":0.3,"description":"横画起笔处","tips":"注意藏锋起笔"}]', '永字八法是书法基础', TRUE);
```

---

## 社区相关表

### 6. posts（帖子表）

**表名**: `posts`  
**说明**: 存储社区帖子内容

| 字段名        | 类型           | 约束                                  | 说明                          |
| ---------- | ------------ | ----------------------------------- | --------------------------- |
| id         | INTEGER      | PRIMARY KEY                         | 帖子ID，主键，自增                  |
| title      | VARCHAR(200) | NULL                                | 帖子标题，可选                     |
| content    | TEXT         | NOT NULL                            | 帖子内容，必填                     |
| category   | VARCHAR(50)  | NULL                                | 帖子类别：技法交流/作品展示/学习心得/问题求助/其他 |
| author_id  | INTEGER      | NOT NULL, FOREIGN KEY               | 作者ID，外键关联users.id           |
| created_at | DATETIME     | DEFAULT CURRENT_TIMESTAMP           | 发布时间                        |
| updated_at | DATETIME     | DEFAULT CURRENT_TIMESTAMP ON UPDATE | 最后更新时间                      |

**索引**:

- PRIMARY KEY: `id`
- INDEX: `author_id` - 查询某用户的帖子
- INDEX: `category` - 按类别筛选
- INDEX: `created_at` - 按时间排序

**外键关系**:

- `author_id` → `users.id` (CASCADE DELETE)

**业务规则**:

- `content`不能为空，最多10000字
- `title`可选，建议填写
- `category`用于帖子分类，前端可自定义类别
- 删除用户时，相关帖子自动删除

**示例数据**:

```sql
INSERT INTO posts (title, content, category, author_id)
VALUES ('分享我的临摹心得', '今天临摹了兰亭序，有一些心得... ', '学习心得', 1);
```

---

### 7. post_comments（帖子评论表）

**表名**: `post_comments`  
**说明**: 存储帖子的评论和回复

| 字段名        | 类型       | 约束                        | 说明                                     |
| ---------- | -------- | ------------------------- | -------------------------------------- |
| id         | INTEGER  | PRIMARY KEY               | 评论ID，主键，自增                             |
| content    | TEXT     | NOT NULL                  | 评论内容，必填                                |
| post_id    | INTEGER  | NOT NULL, FOREIGN KEY     | 帖子ID，外键关联posts.id                      |
| author_id  | INTEGER  | NOT NULL, FOREIGN KEY     | 评论者ID，外键关联users. id                    |
| parent_id  | INTEGER  | NULL, FOREIGN KEY         | 父评论ID，null表示顶级评论，外键关联post_comments. id |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 评论时间                                   |

**索引**:

- PRIMARY KEY: `id`
- INDEX: `post_id` - 查询某帖子的评论
- INDEX: `author_id` - 查询某用户的评论
- INDEX: `parent_id` - 查询某评论的回复

**外键关系**:

- `post_id` → `posts.id` (CASCADE DELETE)
- `author_id` → `users.id` (CASCADE DELETE)
- `parent_id` → `post_comments. id` (CASCADE DELETE)

**业务规则**:

- `parent_id=null`表示这是顶级评论
- `parent_id`有值表示这是对某条评论的回复
- 支持多级回复（理论上无限级，实际建议限制3级）
- 删除顶级评论时，所有回复自动删除

**查询示例**:

```sql
-- 查询帖子的所有顶级评论
SELECT * FROM post_comments WHERE post_id = 1 AND parent_id IS NULL;

-- 查询某评论的所有回复
SELECT * FROM post_comments WHERE parent_id = 1;
```

---

### 8. comments（作品评论表）

**表名**: `comments`  
**说明**: 存储作品的评论和回复（结构与post_comments类似）

| 字段名        | 类型       | 约束                                  | 说明                    |
| ---------- | -------- | ----------------------------------- | --------------------- |
| id         | INTEGER  | PRIMARY KEY                         | 评论ID，主键，自增            |
| content    | TEXT     | NOT NULL                            | 评论内容，必填               |
| work_id    | INTEGER  | NOT NULL, FOREIGN KEY               | 作品ID，外键关联works.id     |
| author_id  | INTEGER  | NOT NULL, FOREIGN KEY               | 评论者ID，外键关联users.id    |
| parent_id  | INTEGER  | NULL, FOREIGN KEY                   | 父评论ID，外键关联comments.id |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP           | 评论时间                  |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE | 更新时间                  |

**索引**:

- PRIMARY KEY: `id`
- INDEX: `work_id`
- INDEX: `author_id`
- INDEX: `parent_id`

**外键关系**:

- `work_id` → `works.id` (CASCADE DELETE)
- `author_id` → `users.id` (CASCADE DELETE)
- `parent_id` → `comments.id` (CASCADE DELETE)

---

## 关系表

### 9. likes（作品点赞表）

**表名**: `likes`  
**说明**: 存储用户对作品的点赞记录

| 字段名        | 类型       | 约束                        | 说明                |
| ---------- | -------- | ------------------------- | ----------------- |
| id         | INTEGER  | PRIMARY KEY               | 点赞ID，主键，自增        |
| user_id    | INTEGER  | NOT NULL, FOREIGN KEY     | 用户ID，外键关联users.id |
| work_id    | INTEGER  | NOT NULL, FOREIGN KEY     | 作品ID，外键关联works.id |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 点赞时间              |

**索引**:

- PRIMARY KEY: `id`
- UNIQUE INDEX: `(user_id, work_id)` - 防止重复点赞
- INDEX: `user_id` - 查询某用户点赞的作品
- INDEX: `work_id` - 查询某作品的点赞数

**约束**:

- UNIQUE: `(user_id, work_id)` - 一个用户对同一作品只能点赞一次

**外键关系**:

- `user_id` → `users. id` (CASCADE DELETE)
- `work_id` → `works.id` (CASCADE DELETE)

**业务规则**:

- 每个用户对每个作品只能点赞一次
- 取消点赞时删除记录
- 删除作品或用户时，相关点赞记录自动删除

**查询示例**:

```sql
-- 查询作品的点赞数
SELECT COUNT(*) FROM likes WHERE work_id = 1;

-- 查询用户是否已点赞
SELECT EXISTS(SELECT 1 FROM likes WHERE user_id = 1 AND work_id = 1);
```

---

### 10.  post_likes（帖子点赞表）

**表名**: `post_likes`  
**说明**: 存储用户对帖子的点赞记录（结构与likes类似）

| 字段名        | 类型       | 约束                        | 说明                 |
| ---------- | -------- | ------------------------- | ------------------ |
| id         | INTEGER  | PRIMARY KEY               | 点赞ID，主键，自增         |
| user_id    | INTEGER  | NOT NULL, FOREIGN KEY     | 用户ID，外键关联users. id |
| post_id    | INTEGER  | NOT NULL, FOREIGN KEY     | 帖子ID，外键关联posts.id  |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 点赞时间               |

**索引**:

- PRIMARY KEY: `id`
- UNIQUE INDEX: `(user_id, post_id)`
- INDEX: `user_id`
- INDEX: `post_id`

**外键关系**:

- `user_id` → `users. id` (CASCADE DELETE)
- `post_id` → `posts.id` (CASCADE DELETE)

---

### 11. collections（收藏表）

**表名**: `collections`  
**说明**: 存储用户对作品的收藏记录

| 字段名        | 类型       | 约束                        | 说明                 |
| ---------- | -------- | ------------------------- | ------------------ |
| id         | INTEGER  | PRIMARY KEY               | 收藏ID，主键，自增         |
| user_id    | INTEGER  | NOT NULL, FOREIGN KEY     | 用户ID，外键关联users. id |
| work_id    | INTEGER  | NOT NULL, FOREIGN KEY     | 作品ID，外键关联works.id  |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 收藏时间               |

**索引**:

- PRIMARY KEY: `id`
- UNIQUE INDEX: `(user_id, work_id)` - 防止重复收藏
- INDEX: `user_id` - 查询某用户的收藏
- INDEX: `work_id` - 查询某作品的收藏数

**约束**:

- UNIQUE: `(user_id, work_id)` - 一个用户对同一作品只能收藏一次

**外键关系**:

- `user_id` → `users.id` (CASCADE DELETE)
- `work_id` → `works.id` (CASCADE DELETE)

**业务规则**:

- 与点赞类似，每个用户对每个作品只能收藏一次
- 取消收藏时删除记录

---

## 系统表

### 12. notifications（通知表）

**表名**: `notifications`  
**说明**: 存储用户的系统通知

| 字段名          | 类型          | 约束                        | 说明                                              |
| ------------ | ----------- | ------------------------- | ----------------------------------------------- |
| id           | INTEGER     | PRIMARY KEY               | 通知ID，主键，自增                                      |
| recipient_id | INTEGER     | NOT NULL, FOREIGN KEY     | 接收者ID，外键关联users. id                             |
| sender_id    | INTEGER     | NULL, FOREIGN KEY         | 发送者ID，外键关联users.id，系统通知时为null                   |
| type         | VARCHAR(20) | NOT NULL                  | 通知类型：like（点赞）/comment（评论）/follow（关注）/system（系统） |
| content      | TEXT        | NOT NULL                  | 通知内容描述                                          |
| related_type | VARCHAR(20) | NULL                      | 关联对象类型：work（作品）/post（帖子）/comment（评论）            |
| related_id   | INTEGER     | NULL                      | 关联对象ID                                          |
| is_read      | BOOLEAN     | DEFAULT FALSE             | 是否已读                                            |
| created_at   | DATETIME    | DEFAULT CURRENT_TIMESTAMP | 通知时间                                            |

**索引**:

- PRIMARY KEY: `id`
- INDEX: `recipient_id` - 查询某用户的通知
- INDEX: `is_read` - 筛选未读通知
- INDEX: `(recipient_id, is_read)` - 联合索引
- INDEX: `created_at` - 按时间排序

**外键关系**:

- `recipient_id` → `users. id` (CASCADE DELETE)
- `sender_id` → `users.id` (SET NULL)

**业务规则**:

- `type`只能是`like`、`comment`、`follow`、`system`之一
- `sender_id`为null表示系统通知
- `related_type`和`related_id`用于跳转到相关页面
- 删除接收者时，通知自动删除
- 删除发送者时，`sender_id`设为null

**示例数据**:

```sql
-- 点赞通知
INSERT INTO notifications (recipient_id, sender_id, type, content, related_type, related_id)
VALUES (1, 2, 'like', 'user2 点赞了你的作品《兰亭序》', 'work', 1);

-- 系统通知
INSERT INTO notifications (recipient_id, sender_id, type, content)
VALUES (1, NULL, 'system', '您的作品《兰亭序》已通过审核');
```

---

### 13. checkins（打卡表）

**表名**: `checkins`  
**说明**: 存储用户的每日打卡记录

| 字段名          | 类型       | 约束                        | 说明                 |
| ------------ | -------- | ------------------------- | ------------------ |
| id           | INTEGER  | PRIMARY KEY               | 打卡ID，主键，自增         |
| user_id      | INTEGER  | NOT NULL, FOREIGN KEY     | 用户ID，外键关联users.id  |
| checkin_date | DATE     | NOT NULL                  | 打卡日期，格式：YYYY-MM-DD |
| created_at   | DATETIME | DEFAULT CURRENT_TIMESTAMP | 打卡时间（具体时刻）         |

**索引**:

- PRIMARY KEY: `id`
- UNIQUE INDEX: `(user_id, checkin_date)` - 每天只能打卡一次
- INDEX: `user_id` - 查询某用户的打卡记录
- INDEX: `checkin_date` - 按日期查询

**约束**:

- UNIQUE: `(user_id, checkin_date)` - 一个用户每天只能打卡一次

**外键关系**:

- `user_id` → `users.id` (CASCADE DELETE)

**业务规则**:

- 每个用户每天只能打卡一次
- `checkin_date`是日期，`created_at`是具体时间
- 用于计算连续打卡天数和累计打卡天数

**查询示例**:

```sql
-- 查询今天是否已打卡
SELECT EXISTS(SELECT 1 FROM checkins WHERE user_id = 1 AND checkin_date = '2025-12-03');

-- 计算连续打卡天数
WITH RECURSIVE dates AS (
  SELECT checkin_date, 1 AS streak
  FROM checkins
  WHERE user_id = 1 AND checkin_date = CURRENT_DATE
  UNION ALL
  SELECT c.checkin_date, d.streak + 1
  FROM checkins c
  INNER JOIN dates d ON c.checkin_date = DATE_SUB(d.checkin_date, INTERVAL 1 DAY)
  WHERE c.user_id = 1
)
SELECT MAX(streak) AS consecutive_days FROM dates;

-- 查询累计打卡天数
SELECT COUNT(*) FROM checkins WHERE user_id = 1;
```

---

## 数据库关系图

```
┌─────────────┐
│   users     │
│             │
│ • id (PK)   │
│ • username  │
│ • email     │
└──────┬──────┘
       │
       ├──────────────────────────────┐
       │                              │
       ▼                              ▼
┌─────────────┐              ┌─────────────┐
│   follows   │              │   works     │
│             │              │             │
│ • follower  │◄────┐        │ • id (PK)   │
│ • following │     │        │ • author_id │◄──┐
└─────────────┘     │        └──────┬──────┘   │
                    │               │          │
                    └───────────────┘          │
                                               │
                    ┌──────────────────────────┤
                    │                          │
                    ▼                          ▼
            ┌─────────────┐          ┌─────────────┐
            │ characters  │          │   likes     │
            │             │          │             │
            │ • id (PK)   │          │ • user_id   │
            │ • work_id   │          │ • work_id   │
            └──────┬──────┘          └─────────────┘
                   │
                   ▼
            ┌─────────────┐
            │ annotations │
            │             │
            │ • id (PK)   │
            │ • char_id   │
            │ • user_id   │
            └─────────────┘
```

---

## 索引设计

### 索引策略

1. **主键索引** (PRIMARY KEY)
   
   - 所有表的`id`字段
   - 自动创建，无需手动添加

2. **唯一索引** (UNIQUE INDEX)
   
   - `users.username`
   - `users.email`
   - `users.phone`
   - `(user_id, work_id)` - likes, collections
   - `(user_id, post_id)` - post_likes
   - `(follower_id, following_id)` - follows
   - `(user_id, checkin_date)` - checkins

3. **普通索引** (INDEX)
   
   - 外键字段：`author_id`, `work_id`, `user_id`, `character_id`, `post_id` 等
   - 筛选字段：`status`, `style`, `dynasty`, `category`, `type`
   - 排序字段：`created_at`, `views`

4. **联合索引** (COMPOSITE INDEX)
   
   - `(recipient_id, is_read)` - notifications
   - `(work_id, text)` - characters

### 索引创建SQL

```sql
-- users表索引
CREATE UNIQUE INDEX idx_users_username ON users(username);
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE UNIQUE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_created_at ON users(created_at);

-- works表索引
CREATE INDEX idx_works_author_id ON works(author_id);
CREATE INDEX idx_works_status ON works(status);
CREATE INDEX idx_works_style ON works(style);
CREATE INDEX idx_works_dynasty ON works(dynasty);
CREATE INDEX idx_works_views ON works(views);
CREATE INDEX idx_works_created_at ON works(created_at);

-- characters表索引
CREATE INDEX idx_characters_text ON characters(text);
CREATE INDEX idx_characters_work_id ON characters(work_id);
CREATE INDEX idx_characters_work_text ON characters(work_id, text);

-- notifications表索引
CREATE INDEX idx_notifications_recipient ON notifications(recipient_id);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
CREATE INDEX idx_notifications_recipient_read ON notifications(recipient_id, is_read);

-- 其他表的索引类似... 
```

---

## 数据迁移脚本

### 初始化数据库

```python
# init_db.py
from app import create_app
from models import db, User

app = create_app()

with app.app_context():
    # 删除所有表
    db. drop_all()

    # 创建所有表
    db.create_all()

    # 创建管理员账号
    admin = User(
        username='admin',
        email='admin@example.com',
        phone='13800138000',
        bio='系统管理员',
        is_admin=True
    )
    admin.set_password('admin123')

    # 创建测试用户
    test_user = User(
        username='testuser',
        email='test@example.com',
        phone='13900139000',
        bio='测试用户'
    )
    test_user.set_password('test123')

    db.session.add(admin)
    db.session.add(test_user)
    db.session.commit()

    print('数据库初始化完成！')
    print('管理员账号：admin / admin123')
    print('测试账号：testuser / test123')
```

### 数据库备份

```bash
# SQLite备份
cp icalligraphy.db icalligraphy_backup_$(date +%Y%m%d).db

# MySQL备份
mysqldump -u root -p icalligraphy > backup_$(date +%Y%m%d).sql

# PostgreSQL备份
pg_dump icalligraphy > backup_$(date +%Y%m%d).sql
```

---

## 性能优化建议

1. **查询优化**
   
   - 使用索引覆盖查询
   - 避免SELECT *，只查询需要的字段
   - 使用分页查询，避免一次性加载大量数据

2. **缓存策略**
   
   - 热门作品列表使用Redis缓存
   - 用户信息使用会话级缓存
   - 统计数据（点赞数、评论数）使用定时更新

3. **数据库分表**
   
   - 当用户数超过100万时，考虑分表
   - 按时间范围分割历史数据

4. **读写分离**
   
   - 使用主从复制
   - 读操作走从库，写操作走主库

---

**文档结束**
